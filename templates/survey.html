{% extends "layout.html" %}
{% block title %}
Survey
{% endblock %}
{% block content %}
<form action="{{url_for("survey", param=param)}}" method="POST">

<h2>{{ survey.title }}</h2>
<p>{{ survey.desc }}</p>


<div class="card">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <label for="firstname" class="form-label">First name:</label>
                <input type="text" class="form-control" id="firstname" name="firstname" placeholder="Oliver" required>
            </div>
            <div class="col-md-6">
                <label for="lastname" class="form-label">Last name:</label>
                <input type="text" class="form-control" id="lastname" name="lastname" placeholder="Skaarup" required>
            </div>
            <div class="col-12">
                <label for="CPR-number" class="form-label">CPR-Number</label>
                <input type="text" class="form-control" id="cpr" name="cpr" placeholder="071296-xxxx" required>
            </div>
        </div>
    </div>
</div>

{% for question in survey.questions %}
    <div class="card question-block" data-question-id="{{question.id}}" data-question-text="{{question.text}}">
        <div class="card-body">
            <label class="question-label">{{question.text}}</label> <br>
            {% for choice in question.choices %}
                <label>
                    <input type="radio" name="question_{{question.id}}" value="{{choice.id}}" data-text="{{choice.text}}" required>
                    {{choice.text}}
                </label> <br>
            {% endfor %}
            <input type="text" class="form-control" name="question_{{question.id}}_uddyb" placeholder="Uddyb svar...">
        </div>
    </div>
    <br>
{% endfor %}
<button class="btn btn-success" type="submit">Indsend!</button>
<button type="button" class="btn btn-primary" onclick="saveToPDF()">Gem som PDF</button>
</form>

<script>
  // En asynchronous funktion vi tilføjer og kalder, som i dette tilfælde er saveToPDF udvidelsen
  async function saveToPDF() {
    // Her importerer vi jsPDF klassen fra det globale jspdf library vi har i layout.html (const betyder at det ikke er en reassigned variabel,
    // f.eks doc, vist længere nede)
    const { jsPDF } = window.jspdf;
    // Her laver vi et dokument instans som vi kan write data til
    const doc = new jsPDF();
    // Her definerer vi hvor på y-aksen vi er i dokumentet, det vil vi så senere hen rykke videre på
    let y = 10;

    // Her har vi en variabel med en metode (getValByName) der finder input baseret på et name attribut
    const getValByName = name => {
      // Her har vi en konstant variabel med en metode (document.querySelector) der søger på input der indeholder et matchende name attribut og returnerer det
      // Man kan også vælge en bestemt name attribut hvis man vil det, f.eks document.querySelector('[name="firstname"]');
      const el = document.querySelector(`[name="${name}"]`);
      // Returnerer den hentede value (name attribute), i det her tilfælde vil den så vise teksten til spørgsmålet
      return el?.value || '';
    };

    const getRadioByName = name => {
      const selected = document.querySelector(`input[name="${name}"]:checked`);
      return selected ? selected.getAttribute("data-text") || selected.value : '';
    };

    // PDF Header
    doc.setFontSize(16);
    doc.text("Besvaret Spørgeskema", 10, y); y += 10;

    // Personal Info
    doc.setFontSize(12);
    doc.text(`First name: ${getValByName("firstname")}`, 10, y); y += 8;
    doc.text(`Last name: ${getValByName("lastname")}`, 10, y); y += 8;
    doc.text(`CPR Number: ${getValByName("cpr")}`, 10, y); y += 10;

    // Loop through questions
    const questionBlocks = document.querySelectorAll(".question-block");
    questionBlocks.forEach((block, index) => {
      const questionId = block.dataset.questionId;
      const questionText = block.dataset.questionText;

      const answer = getRadioByName(`question_${questionId}`);
      const elaboration = getValByName(`question_${questionId}_uddyb`);

      doc.text(`Spørgsmål ${index + 1}: ${questionText}`, 10, y); y += 8;
      doc.text(`Svar: ${answer}`, 10, y); y += 8;

      if (elaboration) {
        doc.text(`Uddybning: ${elaboration}`, 10, y); y += 10;
      } else {
        y += 4;
      }
    });

    doc.save("spoergeskema.pdf");
  }
</script>


{% endblock %}